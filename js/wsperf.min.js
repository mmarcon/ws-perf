window.addEventListener("load",function(){setTimeout(function(){window.scrollTo(0,1)},0)});
(function(f){var d=f.WSPERF={},g;g=function(b,a){var c;c=document;g.emptyElement=c.createElement("div");a?c=c.querySelectorAll(b):(c=c.querySelector(b),c||(c=g.emptyElement));return c};d.BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version";this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(b){for(var a=0;a<
b.length;a++){var c=b[a].string,d=b[a].prop;this.versionSearchString=b[a].versionSearch||b[a].identity;if(c){if(-1!=c.indexOf(b[a].subString))return b[a].identity}else if(d)return b[a].identity}},searchVersion:function(b){var a=b.indexOf(this.versionSearchString);if(-1!=a)return parseFloat(b.substring(a+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},
{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:f.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",
identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"iPad",identity:"iPad"},{string:navigator.platform,
subString:"iPhone",identity:"iPhone"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};d.progress=function(b){var a=d.progress.node||g(".test-progress"),c=document.createElement("p");c.innerHTML=b;a.appendChild(c)};d.Controller=function(){var b="/",a=[],c,d=function(){};c=function(c){var b,h,i=!1;for(b=0;b<a.length;b++)if(h=c.match(a[b].matcher))h.shift(),a[b].callback.apply(null,[c,h]),i=!0;i||d.apply(null,[c])};return{open:function(a){b=a.replace(/^#/,"");c(b)},subscribe:function(c,
b,h){"function"===typeof b&&(a.push({matcher:c,callback:b}),h&&(d=b))},reset:function(){b="/";a.length=0},subscribers:function(){return a.length}}}();d.Templater=function(){var b={};(function(){var a=g(".template",!0);Array.prototype.forEach.call(a,function(a){b[a.id]={content:a.innerHTML,destination:a.dataset.destination}})})();return{use:function(a,c,d){a=b[a];"function"===typeof c&&(d=c,c=null);c=c||{};a&&(c=f.tmpl(a.content,c),a=document.querySelector(a.destination),a.innerHTML=c,"function"===
typeof d&&d.call(null,null))}}}();d.TestSuite=function(){var b=[],a,c,e={};a=function(a){var b="",c,d,a=a||1024;for(c=0;c<a;c++)d=Math.floor(61*Math.random()),b+="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz".substring(d,d+1);return b};c=function(a){this.end=this.start=-1;this.close=this.errors=0;this.done=!1;this.payload=a;this.info={}};c.prototype.run=function(a){var b,c=this;b="Safari"===d.BrowserDetect.browser?new WebSocket("ws://"+f.location.host):new WebSocket("wss://"+f.location.host);
b.onopen=function(){c.start=Date.now();b.send(c.payload)};b.onmessage=function(){c.end=Date.now();c.done=!0;setTimeout(function(){b.close()},1E3);"function"===typeof a&&a.call(c,c.getStats())};b.onclose=function(b,d){c.end=Date.now();c.close+=1;c.info.close=[b,d];"function"===typeof a&&!1===c.done&&a.call(c,c.getStats())};b.onerror=function(){c.end=Date.now();c.error+=1;"function"===typeof a&&a.call(c,c.getStats())}};c.prototype.runXHR=function(c){var a,b=this;a=new XMLHttpRequest;a.open("POST","/helper/xhr");
a.setRequestHeader("Content-Type","application/json");a.onloadstart=function(){b.start=Date.now()};a.onload=function(){b.end=Date.now();b.done=!0;"function"===typeof c&&c.call(b,b.getStats())};a.onerror=function(){b.end=Date.now();b.error+=1;"function"===typeof c&&c.call(b,b.getStats())};a.send(JSON.stringify({p:b.payload}))};c.prototype.getStats=function(){var a={};a.time=this.end-this.start;a.errors=0<this.errors;a.close=0<this.close;a.done=this.done;return a};b.push(function(b){var g=a(1),h=a(1024),
f=a(524288);e.outbandwidth={};d.progress("Testing Websocket upload with small payload");(new c(g)).run(function(a){e.outbandwidth.small=a;d.progress("Testing Websocket upload with medium payload");(new c(h)).run(function(a){e.outbandwidth.medium=a;d.progress("Testing Websocket upload with large payload");(new c(f)).run(function(a){e.outbandwidth.large=a;"function"===typeof b&&b.call(null,e)})})})});b.push(function(a){e.inbandwidth={};d.progress("Testing Websocket download with small payload");(new c("payload-request?p=1")).run(function(b){e.inbandwidth.small=
b;d.progress("Testing Websocket download with medium payload");(new c("payload-request?p=1024")).run(function(b){e.inbandwidth.medium=b;d.progress("Testing Websocket download with large payload");(new c("payload-request?p=524288")).run(function(b){e.inbandwidth.large=b;"function"===typeof a&&a.call(null,e)})})})});b.push(function(b){var g=a(1),h=a(1024),f=a(524288);e.xhr={};d.progress("Testing XHR download with small payload");(new c(g)).runXHR(function(a){e.xhr.small=a;d.progress("Testing XHR download with medium payload");
(new c(h)).runXHR(function(a){e.xhr.medium=a;d.progress("Testing XHR download with large payload");(new c(f)).runXHR(function(a){e.xhr.large=a;"function"===typeof b&&b.call(null,e)})})})});return{run:function(a){var c=function(){var e=b.shift();e?e(c):"function"===typeof a&&a.call(null,d.TestSuite.getResults())};c()},getResults:function(){e.browser={string:d.BrowserDetect.browser+"-"+d.BrowserDetect.version+"-"+d.BrowserDetect.OS,browser:d.BrowserDetect.browser,version:d.BrowserDetect.version,os:d.BrowserDetect.OS};
return e}}}();d.attachEventHandlers=function(){g(".create-test").addEventListener("click",function(b){b.preventDefault();b=new XMLHttpRequest;b.open("GET","/test/new");b.addEventListener("readystatechange",function(){if(4===this.readyState){var a=JSON.parse(this.responseText);d.Templater.use("test",{TEST_ID:a.id||"",TEST_URL:a.url||""},d.attachEventHandlers)}});b.send(null)},!0);g(".run-test").addEventListener("click",function(b){b.preventDefault();var a=this.dataset.test;d.Templater.use("runner",
{TEST_ID:a},d.attachEventHandlers);d.TestSuite.run(function(b){var e=g(".see-test-results");g(".loader").style.visibility="hidden";d.progress("DONE!");e.dataset.results=JSON.stringify(b);var f=new XMLHttpRequest;f.open("POST","/test/"+a+"/save");f.setRequestHeader("Content-Type","application/json");f.addEventListener("readystatechange",function(){if(4===this.readyState){var a=JSON.parse(this.responseText);e.dataset.avg="OK"===a.status?JSON.stringify(a.avg):"unavailable";e.style.visibility="visible"}});
f.send(JSON.stringify(b))})},!0);g(".see-test-results").addEventListener("click",function(b){b.preventDefault();if(this.dataset&&this.dataset.results){d.Templater.use("result",d.attachEventHandlers);var b=JSON.parse(this.dataset.results),a="unavailable"===this.dataset.avg?!1:JSON.parse(this.dataset.avg),c=g("#raphael");Raphael(c,c.offsetWidth,c.offsetHeight).barchart(0,0,c.offsetWidth,c.offsetHeight,[[b.outbandwidth.small.time,b.outbandwidth.medium.time,b.outbandwidth.large.time],[a.outbandwidth.small.time,
a.outbandwidth.medium.time,a.outbandwidth.large.time],[b.inbandwidth.small.time,b.inbandwidth.medium.time,b.inbandwidth.large.time],[a.inbandwidth.small.time,a.inbandwidth.medium.time,a.inbandwidth.large.time],[b.xhr.small.time,b.xhr.medium.time,b.xhr.large.time],[a.xhr.small.time,a.xhr.medium.time,a.xhr.large.time]],{legendcolor:"#fff"}).label()}},!0)};f.addEventListener("load",function(){d.BrowserDetect.init();d.Controller.subscribe(/\/$/,function(){d.Templater.use("home",d.attachEventHandlers)});
d.Controller.subscribe(/\/test\/(test-\d+-\d+)$/,function(b,a){d.Templater.use("test",{TEST_ID:a[0],TEST_URL:f.location},d.attachEventHandlers)});d.Controller.subscribe(/\/404/,function(){d.Templater.use("not-found",d.attachEventHandlers)},!0);d.Controller.open(f.location.pathname)})})(window);
