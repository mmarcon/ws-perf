window.addEventListener("load",function(){setTimeout(function(){window.scrollTo(0,1)},0)});
(function(i){var e=i.WSPERF={},g;g=function(c,a){var b;b=document;g.emptyElement=b.createElement("div");a?b=b.querySelectorAll(c):(b=b.querySelector(c),b||(b=g.emptyElement));return b};e.BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version";this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(c){for(var a=0;a<
c.length;a++){var b=c[a].string,e=c[a].prop;this.versionSearchString=c[a].versionSearch||c[a].identity;if(b){if(-1!=b.indexOf(c[a].subString))return c[a].identity}else if(e)return c[a].identity}},searchVersion:function(c){var a=c.indexOf(this.versionSearchString);if(-1!=a)return parseFloat(c.substring(a+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},
{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:i.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",
identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"iPad",identity:"iPad"},{string:navigator.platform,
subString:"iPhone",identity:"iPhone"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};e.progress=function(c){var a=e.progress.node||g(".test-progress"),b=document.createElement("p");b.innerHTML=c;a.appendChild(b)};e.Controller=function(){var c="/",a=[],b,e=function(){};b=function(b){var h,j,d=!1;for(h=0;h<a.length;h++)if(j=b.match(a[h].matcher))j.shift(),a[h].callback.apply(null,[b,j]),d=!0;d||e.apply(null,[b])};return{open:function(a){c=a.replace(/^#/,"");b(c)},subscribe:function(b,
h,j){"function"===typeof h&&(a.push({matcher:b,callback:h}),j&&(e=h))},reset:function(){c="/";a.length=0},subscribers:function(){return a.length}}}();e.Templater=function(){var c={};(function(){var a=g(".template",!0);Array.prototype.forEach.call(a,function(a){c[a.id]={content:a.innerHTML,destination:a.dataset.destination}})})();return{use:function(a,b,e){a=c[a];"function"===typeof b&&(e=b,b=null);b=b||{};a&&(b=i.tmpl(a.content,b),a=document.querySelector(a.destination),a.innerHTML=b,"function"===
typeof e&&e.call(null,null))}}}();e.TestSuite=function(){var c=[],a,b,g,f={};a=function(h){var a="",d,b,h=h||1024;for(d=0;d<h;d++)b=Math.floor(61*Math.random()),a+="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz".substring(b,b+1);return a};b=function(h){this.end=this.start=-1;this.close=this.errors=0;this.done=!1;this.payload=h;this.info={}};b.prototype.run=function(h){var a,d=this;a="Safari"===e.BrowserDetect.browser?new WebSocket("ws://"+i.location.host):new WebSocket("wss://"+i.location.host);
a.onopen=function(){d.start=Date.now();a.send(d.payload)};a.onmessage=function(){d.end=Date.now();d.done=!0;setTimeout(function(){a.close()},1E3);"function"===typeof h&&h.call(d,d.getStats())};a.onclose=function(a,b){d.end=Date.now();d.close+=1;d.info.close=[a,b];"function"===typeof h&&!1===d.done&&h.call(d,d.getStats())};a.onerror=function(){d.end=Date.now();d.errors+=1;"function"===typeof h&&h.call(d,d.getStats())}};b.prototype.runXHR=function(a){var b,d=this;b=new XMLHttpRequest;b.open("POST",
"/helper/xhr");b.setRequestHeader("Content-Type","application/json");b.onloadstart=function(){d.start=Date.now()};b.onload=function(){d.end=Date.now();d.done=!0;"function"===typeof a&&a.call(d,d.getStats())};b.onerror=function(){d.end=Date.now();d.errors+=1;"function"===typeof a&&a.call(d,d.getStats())};b.send(JSON.stringify({p:d.payload}))};b.prototype.getStats=function(){var a={};a.time=this.end-this.start;a.errors=0<this.errors;a.close=0<this.close;a.done=this.done;return a};g=function(a){this.probes=
a||100;this.results=[];this.errors=0;this.done=!1};g.prototype.run=function(a){var b,d=this,c=0,f;f=function(a){a.send("echo?t="+Date.now());c++};b="Safari"===e.BrowserDetect.browser?new WebSocket("ws://"+i.location.host):new WebSocket("wss://"+i.location.host);b.onopen=function(){f(b)};b.onmessage=function(e){var g=Date.now(),i=-1;c<d.probes?(i=parseInt(e.data,10),d.results.push((g-i)/2),f(b)):(d.done=!0,setTimeout(function(){b.close()},1E3),"function"===typeof a&&a.call(d,d.getStats()))};b.onclose=
function(){"function"===typeof a&&!1===d.done&&a.call(d,d.getStats())};b.onerror=function(){d.end=Date.now();d.errors+=1;"function"===typeof a&&a.call(d,d.getStats())}};g.prototype.runXHR=function(a){var b,d=this,e,c=0;e=function(a){a.open("POST","/helper/xhr");a.send(JSON.stringify({t:Date.now()}));c++};b=new XMLHttpRequest;b.open("POST","/helper/xhr");b.setRequestHeader("Content-Type","application/json");b.addEventListener("readystatechange",function(){debugger;var b=Date.now(),f=-1;4===this.readyState&&
(f=JSON.parse(this.responseText),c<d.probes?(f=f.t,d.results.push((b-f)/2),e(this)):(d.done=!0,"function"===typeof a&&a.call(d,d.getStats())))});b.onerror=function(){d.errors+=1;"function"===typeof a&&a.call(d,d.getStats())};b.send(JSON.stringify({t:Date.now()}))};g.prototype.getStats=function(){var a={};a.results=this.results;a.errors=0<this.errors;a.done=this.done;return a};c.push(function(c){var g=a(1),d=a(1024),i=a(524288);f.outbandwidth={};e.progress("Testing Websocket upload with small payload");
(new b(g)).run(function(a){f.outbandwidth.small=a;e.progress("Testing Websocket upload with medium payload");(new b(d)).run(function(a){f.outbandwidth.medium=a;e.progress("Testing Websocket upload with large payload");(new b(i)).run(function(a){f.outbandwidth.large=a;"function"===typeof c&&c.call(null,f)})})})});c.push(function(a){f.inbandwidth={};e.progress("Testing Websocket download with small payload");(new b("payload-request?p=1")).run(function(c){f.inbandwidth.small=c;e.progress("Testing Websocket download with medium payload");
(new b("payload-request?p=1024")).run(function(d){f.inbandwidth.medium=d;e.progress("Testing Websocket download with large payload");(new b("payload-request?p=524288")).run(function(b){f.inbandwidth.large=b;"function"===typeof a&&a.call(null,f)})})})});c.push(function(a){e.progress("Testing Websocket latency");(new g(100)).run(function(b){f.latency=b;a.call(null,f)})});c.push(function(c){var g=a(1),d=a(1024),i=a(524288);f.xhroutbandwidth={};e.progress("Testing XHR upload with small payload");(new b(g)).runXHR(function(a){f.xhroutbandwidth.small=
a;e.progress("Testing XHR upload with medium payload");(new b(d)).runXHR(function(a){f.xhroutbandwidth.medium=a;e.progress("Testing XHR upload with large payload");(new b(i)).runXHR(function(a){f.xhroutbandwidth.large=a;"function"===typeof c&&c.call(null,f)})})})});c.push(function(a){f.xhrinbandwidth={};e.progress("Testing XHR download with small payload");(new b("1")).runXHR(function(c){f.xhrinbandwidth.small=c;e.progress("Testing XHR download with medium payload");(new b("1024")).runXHR(function(d){f.xhrinbandwidth.medium=
d;e.progress("Testing XHR download with large payload");(new b("524288")).runXHR(function(b){f.xhrinbandwidth.large=b;"function"===typeof a&&a.call(null,f)})})})});c.push(function(a){e.progress("Testing XHR latency");(new g(100)).runXHR(function(b){f.xhrlatency=b;a.call(null,f)})});return{run:function(a){var b=function(){var d=c.shift();d?d(b):"function"===typeof a&&a.call(null,e.TestSuite.getResults())};b()},getResults:function(){f.browser={string:e.BrowserDetect.browser+"-"+e.BrowserDetect.version+
"-"+e.BrowserDetect.OS,browser:e.BrowserDetect.browser,version:e.BrowserDetect.version,os:e.BrowserDetect.OS};return f}}}();e.attachEventHandlers=function(){g(".create-test").addEventListener("click",function(c){c.preventDefault();c=new XMLHttpRequest;c.open("GET","/test/new");c.addEventListener("readystatechange",function(){if(4===this.readyState){var a=JSON.parse(this.responseText);e.Templater.use("test",{TEST_ID:a.id||"",TEST_URL:a.url||""},e.attachEventHandlers)}});c.send(null)},!0);g(".run-test").addEventListener("click",
function(c){c.preventDefault();var a=this.dataset.test;e.Templater.use("runner",{TEST_ID:a},e.attachEventHandlers);e.TestSuite.run(function(b){var c=g(".see-test-results");g(".loader").style.visibility="hidden";e.progress("DONE!");c.dataset.results=JSON.stringify(b);var f=new XMLHttpRequest;f.open("POST","/test/"+a+"/save");f.setRequestHeader("Content-Type","application/json");f.addEventListener("readystatechange",function(){if(4===this.readyState){var a=JSON.parse(this.responseText);c.dataset.avg=
"OK"===a.status?JSON.stringify(a.avg):"unavailable";c.style.visibility="visible"}});f.send(JSON.stringify(b))})},!0);g(".see-test-results").addEventListener("click",function(c){c.preventDefault();if(this.dataset&&this.dataset.results){e.Templater.use("result",e.attachEventHandlers);var c=JSON.parse(this.dataset.results),a="unavailable"===this.dataset.avg?!1:JSON.parse(this.dataset.avg),b=g("#raphael");Raphael(b,b.offsetWidth,b.offsetHeight).barchart(0,0,b.offsetWidth,b.offsetHeight,[[c.outbandwidth.small.time,
c.outbandwidth.medium.time,c.outbandwidth.large.time],[a.outbandwidth.small.time,a.outbandwidth.medium.time,a.outbandwidth.large.time],[c.inbandwidth.small.time,c.inbandwidth.medium.time,c.inbandwidth.large.time],[a.inbandwidth.small.time,a.inbandwidth.medium.time,a.inbandwidth.large.time],[c.xhroutbandwidth.small.time,c.xhroutbandwidth.medium.time,c.xhroutbandwidth.large.time],[a.xhroutbandwidth.small.time,a.xhroutbandwidth.medium.time,a.xhroutbandwidth.large.time],[c.xhrinbandwidth.small.time,c.xhrinbandwidth.medium.time,
c.xhrinbandwidth.large.time],[a.xhrinbandwidth.small.time,a.xhrinbandwidth.medium.time,a.xhrinbandwidth.large.time]],{legendcolor:"#fff"}).label()}},!0)};i.addEventListener("load",function(){e.BrowserDetect.init();e.Controller.subscribe(/\/$/,function(){e.Templater.use("home",e.attachEventHandlers)});e.Controller.subscribe(/\/test\/(test-\d+-\d+)$/,function(c,a){e.Templater.use("test",{TEST_ID:a[0],TEST_URL:i.location},e.attachEventHandlers)});e.Controller.subscribe(/\/404/,function(){e.Templater.use("not-found",
e.attachEventHandlers)},!0);e.Controller.open(i.location.pathname)})})(window);
